# CSIP

This repository contains the implementation of CSIP and can be used to reproduce the results in the paper. The implementation is based on an open source implementation of OpenAI's [CLIP](https://github.com/openai/CLIP). 

## Abstract
Advanced AI developments have been transforming the biomedical field. The emergence of multi-modal biomedical data, such as imaging, sequencing and other omics data, further enables training AI models for complex analytical tasks. However, such data analysis remains challenging due to the difficulty of integrating information from different modalities. In this paper, we aim to address this challenge by proposing a methodology to integrate both image and molecular structure data. We present a Contrastive Structure-to-Image Pretraning (CSIP) framework, which leverages a self-supervised Graph Neural Network (GNN) to encode molecules and images into a joint feature representation space. This direct mapping between the two modalities enables a wide variety of applications, including image profiling and clustering of molecules based on their effects on cell morphology. Image profiles generated by CSIP archived an AUC of $0.708$ when predicting biological activities, outperforming the state-of-the-art fully supervised methodologies. Further, CSIP improved the accuracy of image-molecule matching by $29$-folds from the random baseline after being trained on a small dataset, which demonstrated data efficiency.

![image](contrastive.png)

## Data
The dataset we used can be found at [here](https://gigadb.org/dataset/100200), and the scripts for downloading the dataset can be found at [here](https://github.com/gigascience/paper-bray2017/tree/master?tab=readme-ov-file), along with the SMILES representation of molecules. 

Metadata can be found at data\plates_metadata. Images are not provided. 

## Environment setup
    conda create --name CSIP --file requirements.txt
    conda activate CSIP

## Usage

First, run the image processing pipeline using

    python build.py \
    --data_path "<path_to_image_set>" \ 
    --metadata_path "data\plates_metadata" \ 
    --save "<folder_to_save_outputs>" \
    --centroids_file "coord.csv" \
    --metadata_file "profiles.csv" \
    --quality_control "qc.csv" \ 
    --conversion "data\plates_metadata\chemical_annotations.csv"\ 
    --model_path "CSIP\parameters\conv.pth" \ 
    --illum_path "illumination_correction_functions\(plate)_IllumER" "illumination_correction_functions\(plate)_IllumRNA" "illumination_correction_functions\(plate)_IllumDNA" "illumination_correction_functions\(plate)_IllumMito" "illumination_correction_functions\(plate)_IllumAGP" 

Processed data will be saved to the "output" folder by default. 

Next, unwrap the processed dataset 

    python unwrap.py \
    --data_path "<path_to_processed_data>" \
    --save_feature "<path_to_save_unwrapped_dataset>" \
    --save_label "<path_to_save_labels>"

Finally, run the training script

    python train.py \ 
    --load_dir "<path_to_unwrapped_dataset>" \
    --load_dir_label "<path_to_labels_set>" \
    --save_dir "<folder_to_save_outputs>" \
    --device "cpu" \
    --use_wandb 0 \
    --debug 0 \
    --learnable_tau 1 \
    --lr 0.001 \
    --loss "standard" 

## Retrieval task
We provide a [Jupyter notebook](https://github.com/LeoL18/CSIP/blob/master/retrieval.ipynb) for a demonstration of molecule retrieval with CSIP. 
